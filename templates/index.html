<!DOCTYPE html>
<html>
<head>
    <title>EV Charging Station Recommendation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        #map {
            height: 500px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h2>EV Charging Station Recommendation App</h2>
    <button onclick="getLocationAndSend()">Use My Location & Show Nearest Stations</button>
    <div id="result"></div>
    <div id="map"></div>

    <script>
        let map;

        function getLocationAndSend() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async function(position) {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    // Haritayı oluştur ve kullanıcı konumuna göre ortala
                    if (map) map.remove(); // önceki haritayı temizle
                    map = L.map('map').setView([userLat, userLon], 13);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a>'
                    }).addTo(map);

                    // Kullanıcı konumunu göster
                    const userMarker = L.marker([userLat, userLon]).addTo(map).bindPopup("You are here").openPopup();

                    // API'den önerilen istasyonu al
                    const response = await fetch('/recommend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lat: userLat, lon: userLon })
                    });

                    const data = await response.json();
                    const best = data[0];

                    // İstasyon konumu
                    const stationLat = best.coordinates[1];
                    const stationLon = best.coordinates[0];
                    const stationCoords = [stationLat, stationLon];

                    // İstasyon marker'ı ekle
                    const stationMarker = L.marker(stationCoords).addTo(map).bindPopup(best.name);

                    // Bilgileri göster
                    document.getElementById("result").innerHTML = `
                        <h3>Top Recommended Station:</h3>
                        <p><b>${best.name}</b><br>
                        Distance: ${best.distance} km<br>
                        Occupancy: ${best.occupancy}%<br>
                        Charging Speed: ${best.charging_speed} kW<br>
                        Price: ${best.price} PLN/kWh<br>
                        Score: ${best.score}</p>
                    `;

                    // Rota verisi al
                    const routeRes = await fetch('/route', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            start: [userLon, userLat],
                            end: best.coordinates
                        })
                    });

                    const routeData = await routeRes.json();

                    // Koordinatları uygun formata çevir
                    const routeCoords = routeData.features[0].geometry.coordinates.map(c => [c[1], c[0]]);

                    // Rota çiz
                    L.polyline(routeCoords, { color: 'blue', weight: 5 }).addTo(map);
                }, function(error) {
                    alert("Failed to get your location.");
                });
            } else {
                alert("Location access not available.");
            }
        }
    </script>
</body>
</html>
